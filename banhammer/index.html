<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BAN HAMMER 9000 - ULTIMATE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #050505;
            color: #33ff00;
            font-family: 'VT323', monospace;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            cursor: none; 
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: #000;
            overflow: hidden;
            transition: background 0.2s ease;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        #cursorCanvas {
            display: block;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 9999;
            pointer-events: none; 
        }

        /* CRT Overlay Effects */
        .scanlines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.2) 50%,
                rgba(0,0,0,0.2)
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
        }

        .crt-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.6) 100%);
            box-shadow: inset 0 0 10rem rgba(0,0,0,0.9);
            pointer-events: none;
            z-index: 11;
        }

        #flash-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 15;
            transition: opacity 0.1s;
        }

        #blackout-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            opacity: 0;
            pointer-events: none;
            z-index: 14;
            transition: opacity 0.2s;
        }
        
        #vignette-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 40%, rgba(100, 0, 20, 0.6) 100%);
            opacity: 0;
            pointer-events: none;
            z-index: 13;
            transition: opacity 1s;
        }

        #drunk-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            backdrop-filter: blur(0px);
            pointer-events: none;
            z-index: 12;
            transition: backdrop-filter 0.5s;
        }

        /* UI Overlay */
        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 50; 
            font-size: 2rem;
            text-shadow: 0 0 5px #33ff00;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: color 0.5s;
        }

        #audio-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 102;
        }
        
        .icon-btn {
            background: none;
            border: 2px solid currentColor;
            color: inherit;
            font-family: 'VT323', monospace;
            font-size: 1.5rem;
            padding: 5px 10px;
            cursor: pointer;
            pointer-events: auto;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.2); }

        @media (max-width: 600px) {
            #ui-layer { font-size: 1.2rem; top: 10px; left: 10px; }
            h1 { font-size: 2.5rem; }
            h2 { font-size: 2rem; }
            #audio-controls { top: 10px; right: 10px; }
            #mom-phone-btn { width: 80px; height: 80px; bottom: 20px; right: 20px; font-size: 30px; }
        }

        .hud-item {
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border: 1px solid currentColor;
        }

        #level-indicator { color: #ffff00; }
        #combo-display { color: #ff00ff; display: none; font-size: 2.5rem; animation: pulse 0.2s infinite; }
        #highscore-display { color: #00ffff; font-size: 1.5rem; }

        #game-over, #level-up-screen, .start-screen, #game-win {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .start-screen { background: rgba(0, 0, 0, 0.85); }
        #game-over, #level-up-screen, #game-win { background: rgba(0, 0, 0, 0.9); display: none; }

        #game-over-content, #level-up-content, #game-win-content {
             border: 2px solid #33ff00;
             padding: 2rem;
             background: #000;
             text-align: center;
             box-shadow: 0 0 20px #33ff00;
             min-width: 300px;
        }

        h1 { margin: 0 0 20px 0; font-size: 4rem; text-transform: uppercase; color: #ff3333; text-shadow: 2px 2px #fff; }
        h2 { color: #ffff00; font-size: 3rem; margin: 0 0 20px 0; }

        button {
            background: #33ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-family: 'VT323', monospace;
            font-size: 2rem;
            cursor: pointer;
            text-transform: uppercase;
            margin-top: 20px;
            position: relative;
            z-index: 101;
        }
        button:hover { background: #fff; }

        .retro-text {
            color: #33ff00;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            text-shadow: 0 0 5px #33ff00;
            max-width: 600px;
            text-align: center;
            padding: 0 20px;
        }
        
        .small-text {
            color: #888;
            font-size: 1rem;
            margin-top: 30px;
            text-transform: uppercase;
        }

        .warning-text {
            color: #ff0055;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.7; transform: scale(0.98); }
            50% { opacity: 1; transform: scale(1.02); }
            100% { opacity: 0.7; transform: scale(0.98); }
        }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <canvas id="cursorCanvas"></canvas>

    <div id="flash-overlay"></div>
    <div id="blackout-overlay"></div>
    <div id="vignette-overlay"></div>
    <div id="drunk-overlay"></div>
    
    <div class="scanlines"></div>
    <div class="crt-overlay"></div>

    <div id="audio-controls">
        <button class="icon-btn" id="mute-btn" onclick="toggleMute()">üîä</button>
    </div>

    <!-- Phone Button (Hidden until 8 digits) -->
    <div id="mom-phone-btn" onclick="callMom()" style="display: none;">‚òéÔ∏è</div>

    <div id="ui-layer">
        <div class="hud-item">SCORE: <span id="score">0</span></div>
        <div class="hud-item" id="highscore-display">HIGH SCORE: <span id="highscore">0</span></div>
        <div class="hud-item" id="level-indicator">LEVEL: 1 - THE VOID</div>
        
        <div class="hud-item" id="progress-container" style="padding: 5px; display: flex; flex-direction: column; gap: 2px; width: 200px;">
            <div style="font-size: 1rem; opacity: 0.8;">NEXT LEVEL:</div>
            <div style="width: 100%; height: 10px; background: rgba(0,0,0,0.5); border: 1px solid currentColor;">
                <div id="progress-fill" style="width: 0%; height: 100%; background: currentColor; transition: width 0.2s;"></div>
            </div>
        </div>

        <div id="boss-hud">
            <div>MOM'S PHONE #:</div>
            <div id="phone-number-display" style="font-size: 2rem; letter-spacing: 5px;">_ _ _ _ _ _ _ _</div>
        </div>

        <div class="hud-item">SERVER LOAD: <span id="lives">0</span>%</div>
        <div id="combo-display">COMBO x<span id="combo-count">0</span></div>
        <div id="rage-display" style="color: red; font-size: 2rem; display: none; animation: pulse 0.1s infinite;">üî• RAGE MODE üî•</div>
    </div>

    <div id="start-screen" class="start-screen">
        <h1 style="color: #33ff00;">BAN HAMMER 9000</h1>
        <div class="retro-text">OPPDRAG: RENS CHATTEN FOR TROLL.</div>
        <div class="retro-text warning-text">NYE FIENDER: BOTS, POP-UPS & BINDERS!</div>
        <div class="retro-text" style="color: #ffff00; margin-top: 20px;">MENY: HAMMEREN ER DIN PEKER!</div>
        <button onclick="startGame()">INIT SYSTEM</button>
        <div class="small-text">Anbefales p√• PC (men funker p√• mobil)</div>
    </div>

    <div id="level-up-screen">
        <div id="level-up-content">
            <h2>LEVEL OPP!</h2>
            <div class="retro-text" id="level-desc">Nytt milj√∏ lastet inn...</div>
            <div class="retro-text" id="level-hint" style="color: #ffff00; font-size: 1.2rem; margin-top: 15px;"></div>
            <button onclick="nextLevel()">FORTSETT</button>
        </div>
    </div>

    <div id="game-over">
        <div id="game-over-content">
            <h1>SYSTEM CRASH</h1>
            <p class="retro-text" id="game-over-reason">Serveren ble overbelastet.</p>
            <p class="retro-text">Final Score: <span id="final-score">0</span></p>
            <button onclick="resetGame()">REBOOT</button>
        </div>
    </div>

    <div id="game-win">
        <div id="game-win-content">
            <h1 style="color: #00ff00;">SEIER!</h1>
            <p class="retro-text">"MAMMA! HAN SL√ÖR MEG!"</p>
            <p class="retro-text">Mega Trollet l√∏p hjem.</p>
            <p class="retro-text">Chatten er trygg... for n√•.</p>
            <p class="retro-text">Score: <span id="win-score">0</span></p>
            <button onclick="resetGame()">SPILL IGJEN</button>
        </div>
    </div>
</div>

<script>
    // --- AUDIO SYSTEM ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    let isMuted = false;
    let musicTimer;
    let isMusicPlaying = false;
    let noteIndex = 0;
    let beatPulse = 0; 

    const SEQUENCES = {
        1: [55, 0, 55, 0, 65, 0, 55, 0], 
        2: [220, 220, 261, 261, 330, 220, 196, 220],
        3: [65, 69, 73, 69, 65, 69, 73, 77],
        4: [440, 0, 880, 0, 440, 880, 440, 0],
        5: [110, 108, 110, 55, 110, 108, 110, 220],
        6: [110, 0, 110, 0, 110, 0, 110, 0],
        7: [220, 220, 0, 220, 220, 0, 440, 0], 
        8: [55, 55, 65, 55, 82, 82, 73, 55] 
    };

    function initAudio() {
        if (!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function toggleMute() {
        isMuted = !isMuted;
        const btn = document.getElementById('mute-btn');
        btn.innerText = isMuted ? "üîá" : "üîä";
        if (isMuted) { stopMusic(); if(audioCtx) audioCtx.suspend(); } 
        else { if(audioCtx) audioCtx.resume(); if(gameActive) startMusic(); }
    }

    function startMusic() {
        if (isMusicPlaying || isMuted || !audioCtx) return;
        isMusicPlaying = true;
        noteIndex = 0;
        scheduleMusicNote();
    }

    function stopMusic() {
        isMusicPlaying = false;
        if (musicTimer) clearTimeout(musicTimer);
    }

    function scheduleMusicNote() {
        if (!isMusicPlaying || !audioCtx) return;
        const now = audioCtx.currentTime;
        const seq = SEQUENCES[currentLevel] || SEQUENCES[1];
        const freq = seq[noteIndex % seq.length];
        
        if (freq > 0) {
            if (currentLevel === 8) { // Boss
                playTone('sawtooth', freq, freq/2, 0.1, now, 0.3);
                playTone('square', freq*2, freq, 0.05, now, 0.1); 
            } else if (currentLevel === 7) { // Desktop
                playTone('sine', freq, freq, 0.2, now, 0.1); // Elevator music
            } else if (currentLevel === 6) {
                if(noteIndex % 2 !== 0) playTone('sawtooth', 60, 60, 0.2, now, 0.5); 
                if(noteIndex % 8 === 0) playTone('square', 440, 440, 0.2, now, 0.1);
            } else if (currentLevel === 5) {
                playTone('sawtooth', freq, freq/2, 0.1, now, 0.2);
            } else if (currentLevel === 4) playTone('sine', freq, freq, 0.05, now, 0.1);
            else if (currentLevel === 3) playTone('sawtooth', freq, freq + Math.random()*5, 0.3, now, 0.15);
            else if (currentLevel === 2) playTone('square', freq, freq, 0.1, now, 0.1);
            else playTone('triangle', freq, freq * 0.5, 0.4, now, 0.3);
        }

        if (currentLevel >= 2 && noteIndex % 2 === 0) playNoise(0.02, now, 0.05); 
        if (currentLevel >= 4 && noteIndex % 4 === 0) playNoise(0.1, now, 0.1); 
        if (currentLevel === 6 || currentLevel === 8) {
            if(noteIndex % 2 === 0) { playTone('sine', 150, 40, 0.15, now, 0.8); playNoise(0.01, now, 0.2); beatPulse = 1.0; }
            if(noteIndex % 2 !== 0) playNoise(0.1, now, 0.2); 
        }

        noteIndex++;
        
        let tempo = 250; 
        if (currentLevel === 2) tempo = 150;
        if (currentLevel === 3) tempo = 300; 
        if (currentLevel === 4) tempo = 120; 
        if (currentLevel === 5) tempo = 100; 
        if (currentLevel === 6) tempo = 125;
        if (currentLevel === 7) tempo = 200; 
        if (currentLevel === 8) tempo = 90; 

        musicTimer = setTimeout(scheduleMusicNote, tempo);
    }

    function playTone(type, startFreq, endFreq, duration, startTime, vol = 0.2) {
        if (!audioCtx || isMuted) return;
        const t = startTime || audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.type = type;
        osc.frequency.setValueAtTime(startFreq, t);
        osc.frequency.exponentialRampToValueAtTime(Math.max(1, endFreq), t + duration);
        gain.gain.setValueAtTime(vol, t);
        gain.gain.exponentialRampToValueAtTime(0.01, t + duration);
        osc.start(t); osc.stop(t + duration);
    }

    function playNoise(duration, startTime, vol = 0.3) {
        if (!audioCtx || isMuted) return;
        const t = startTime || audioCtx.currentTime;
        const bufSize = audioCtx.sampleRate * duration;
        const buffer = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufSize; i++) data[i] = Math.random() * 2 - 1;
        const noise = audioCtx.createBufferSource();
        noise.buffer = buffer;
        const gain = audioCtx.createGain();
        noise.connect(gain); gain.connect(audioCtx.destination);
        gain.gain.setValueAtTime(vol, t);
        gain.gain.exponentialRampToValueAtTime(0.01, t + duration);
        noise.start(t);
    }

    const sfx = {
        hit: () => playTone('square', 150, 40, 0.1, 0, 0.15),
        hitBig: () => playNoise(0.3, 0, 0.4),
        bad: () => playTone('sawtooth', 100, 50, 0.3, 0, 0.2),
        error: () => { 
             if(!audioCtx || isMuted) return;
             playTone('sawtooth', 50, 200, 0.1, 0, 0.2); setTimeout(() => playTone('square', 200, 50, 0.1, 0, 0.2), 100);
        },
        powerup: () => {
            if(!audioCtx || isMuted) return;
            const now = audioCtx.currentTime; [440, 554, 659].forEach((f, i) => playTone('sine', f, f, 0.3, now + i*0.1, 0.1));
        },
        drunk: () => { if(!audioCtx || isMuted) return; playTone('sine', 200, 150, 0.5, 0, 0.2); },
        rare: () => { if(!audioCtx || isMuted) return; playTone('square', 880, 1760, 0.5, 0, 0.3); setTimeout(() => playTone('square', 1760, 880, 0.5, 0, 0.3), 100); },
        win: () => { if(!audioCtx || isMuted) return; [523, 659, 784, 1046].forEach((f, i) => playTone('triangle', f, f, 0.5, audioCtx.currentTime + i*0.2, 0.3)); },
        pop: () => { if(!audioCtx || isMuted) return; playTone('triangle', 300, 350, 0.05, 0, 0.1); }
    };

    // --- GAME VARIABLES ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const cursorCanvas = document.getElementById('cursorCanvas');
    const cursorCtx = cursorCanvas.getContext('2d');
    
    const uiLayer = document.getElementById('ui-layer');
    const scoreEl = document.getElementById('score');
    const highscoreEl = document.getElementById('highscore');
    const livesEl = document.getElementById('lives');
    const levelEl = document.getElementById('level-indicator');
    const comboDisplayEl = document.getElementById('combo-display');
    const comboCountEl = document.getElementById('combo-count');
    const rageDisplayEl = document.getElementById('rage-display');
    const progressFillEl = document.getElementById('progress-fill');
    const progressContainer = document.getElementById('progress-container');
    
    const gameOverEl = document.getElementById('game-over');
    const gameOverReasonEl = document.getElementById('game-over-reason');
    const gameWinEl = document.getElementById('game-win');
    const levelUpEl = document.getElementById('level-up-screen');
    const levelDescEl = document.getElementById('level-desc');
    const levelHintEl = document.getElementById('level-hint');
    const startScreenEl = document.getElementById('start-screen');
    const finalScoreEl = document.getElementById('final-score');
    const winScoreEl = document.getElementById('win-score');
    
    const flashOverlay = document.getElementById('flash-overlay');
    const blackoutOverlay = document.getElementById('blackout-overlay');
    const vignetteOverlay = document.getElementById('vignette-overlay');
    const drunkOverlay = document.getElementById('drunk-overlay');
    
    const bossHud = document.getElementById('boss-hud');
    const phoneNumberDisplay = document.getElementById('phone-number-display');
    const momPhoneBtn = document.getElementById('mom-phone-btn');

    let width, height;
    let score = 0;
    let highScore = localStorage.getItem('banHammerHighScore') || 0;
    let serverLoad = 0; 
    let gameActive = false; 
    let frame = 0;
    let currentLevel = 1;
    let hitStop = 0;
    let glitchEffect = 0;
    let combo = 0;
    let isTouchInput = false;
    let drunkLevel = 0;
    let rageMode = false;
    let rageTimer = 0;

    let mouseX = width/2;
    let mouseY = height/2;
    let isClicking = false;
    let hammerRotation = 0;
    let shakeIntensity = 0;

    let entities = [];
    let particles = [];
    let floatText = [];
    let shockwaves = [];
    let bgElements = [];

    // Boss Variables
    let boss = null;
    let collectedDigits = [];
    let nextDigit = 1;
    let bossState = 'idle'; // idle, attack, cooldown
    let bossTimer = 0;

    highscoreEl.innerText = highScore;

    const LEVEL_THRESHOLDS = { 1: 0, 2: 50, 3: 150, 4: 350, 5: 600, 6: 900, 7: 1200, 8: 1500 };
    const LEVEL_NAMES = { 
        1: "THE VOID", 
        2: "IRC CHATROOM", 
        3: "PREDATOR ALLEY", 
        4: "FUGLE-APPEN", 
        5: "M√òRKENETTET", 
        6: "IRL FEST", 
        7: "DESKTOP HELL", 
        8: "BOSS FIGHT" 
    };

    const LEVEL_HINTS = {
        2: "HINT: Chatten ruller fort. Hold fokus!",
        3: "ADVARSEL: PREDATORS jakter p√• barna. Beskytt dem!",
        4: "NY FIENDE: BOTS spammer serveren. Sl√• dem!",
        5: "ADVARSEL: VIRUS oppdaget. R√∏r og du mister poeng!",
        6: "HINT: Unng√• alkohol, ellers blir du full!",
        7: "SYSTEM FEIL: Pop-ups formerer seg hvis du er treg!",
        8: "BOSS FIGHT: Beskytt barna og samle telefonnummeret!"
    };

    const trollInsults = ["Noob!", "Hax!", "Ratio", "Ez", "Taper", "Bot", "Cringe", "Lag!", "Cry more"];
    const complaintWords = ["D√ÖRLIG!", "KJEDELIG!", "HAT!", "UNFOLLOW!", "DISLIKE!", "DUM!", "TEIT!"];
    const nicePhrases = ["Hei!", "GG!", "Kult!", "Venn?", ":)", "Bra spilt", "Lykke til"];
    const predatorPhrases = ["...", "Sulten", "Kom hit", "Nam nam", "Bli med", "M√∏rket..."];
    const botPhrases = ["BEEP", "BUY CRYPTO", "CLICK HERE", "FREE IPHONE", "BOOP", "FOLLOW ME"];
    const partyInsults = ["Sk√•l!", "Chug!", "En til?", "Hvor er √∏let?", "Kjedelig!", "Fest!"];
    const goldenPhrases = ["GULL!", "STONKS!", "CATCH ME!", "RICH!", "$$$"];
    const popupPhrases = ["WIN $1M", "HOT SINGLES", "ERROR 404", "DOWNLOAD RAM", "VIRUS DETECTED", "CLICK ME"];
    const clippyPhrases = ["Trenger du hjelp?", "Skal jeg banne?", "Jeg ser du sliter...", "Hei p√• deg!"];
    
    const ircNames = ["<Slayer>", "<Admin>", "<Guest>", "<TrollHunter>"];
    const ircChat = ["lol", "brb", "asl?", "xD", "rofl"];
    const matrixChars = "010101XYZA";
    const hashtags = ["#Trending", "#Viral", "#News", "#CatVideo", "#BanHammer"];

    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
        cursorCanvas.width = width;
        cursorCanvas.height = height;
        initBackgroundElements();
    }
    window.addEventListener('resize', resize);
    resize();

    // --- INPUT HANDLING ---
    document.addEventListener('mousemove', (e) => {
        isTouchInput = false; 
        mouseX = e.clientX;
        mouseY = e.clientY;
    });

    document.addEventListener('mousedown', triggerSwing);

    const handleTouch = (e) => {
        isTouchInput = true; 
        const touch = e.touches[0];
        mouseX = touch.clientX;
        mouseY = touch.clientY - 80; 

        if (e.target.tagName === 'BUTTON' || e.target.closest('button') || e.target.id === 'mom-phone-btn') return;
        if (e.cancelable) e.preventDefault();
    };

    document.addEventListener('touchmove', handleTouch, { passive: false });
    
    document.addEventListener('touchstart', (e) => {
        handleTouch(e);
        triggerSwing();
    }, { passive: false });

    function triggerSwing() {
        if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        if (isClicking) return;
        isClicking = true;
        hammerRotation = -45; 
        setTimeout(() => {
            hammerRotation = 60; 
            if (gameActive) {
                checkHits();
                if(shakeIntensity < 2) shakeIntensity = 2; 
            }
        }, 50);
        setTimeout(() => {
            isClicking = false;
            hammerRotation = 0;
        }, 200);
    }

    function callMom() {
        gameActive = false;
        sfx.win();
        winScoreEl.innerText = score;
        gameWinEl.style.display = 'flex';
        momPhoneBtn.style.display = 'none';
        bossHud.style.display = 'none';
    }

    function initBackgroundElements() {
        bgElements = [];
        let count = 20;
        if (currentLevel === 5) count = 50; 
        for(let i=0; i<count; i++) bgElements.push(createBgElement(true));
    }

    function createBgElement(randomY = false) {
        const y = randomY ? Math.random() * height : (currentLevel === 5 ? -20 : height + 20);
        let el = { x: Math.random() * width, y: y, speed: 0.5 + Math.random() * 0.5, opacity: 0.1 + Math.random() * 0.2, text: "" };

        if (currentLevel === 2) {
             const name = ircNames[Math.floor(Math.random() * ircNames.length)];
             const msg = ircChat[Math.floor(Math.random() * ircChat.length)];
             el.text = `[${Math.floor(Math.random()*23)}:${Math.floor(Math.random()*59)}] ${name} ${msg}`;
             el.x = 40; 
        } else if (currentLevel === 4) {
             el.text = Math.random() > 0.5 ? "‚òÅ" : "üê¶"; 
             el.speed = 1 + Math.random(); 
             el.y = Math.random() * height;
             el.x = randomY ? Math.random() * width : -50;
        } else if (currentLevel === 5) {
             el.text = matrixChars[Math.floor(Math.random() * matrixChars.length)];
             el.speed = 5 + Math.random() * 5; 
             el.x = Math.floor(Math.random() * (width / 20)) * 20; 
        }
        return el;
    }

    class Entity {
        constructor(type) {
            this.type = type; 
            this.radius = 30;
            this.x = Math.random() * (width - 100) + 50;
            this.y = height + 50; 
            this.targetY = Math.random() * (height - 200) + 100;
            this.state = 'entering';
            this.markedForDeletion = false;
            this.phrase = "";
            this.phraseTimer = Math.floor(Math.random() * 60);
            this.showPhrase = false;
            this.pulse = 0;
            this.timer = 0; // Generic timer

            if (type === 'troll') {
                this.speedX = (Math.random() - 0.5) * 5; this.speedY = -Math.random() * 4 - 3;
                this.color = Math.random() > 0.5 ? '#ff0055' : '#ff3300';
                this.phrase = trollInsults[Math.floor(Math.random() * trollInsults.length)];
                this.scoreValue = 2; this.loadImpact = -2;
            } else if (type === 'innocent') {
                this.speedX = (Math.random() - 0.5) * 3; this.speedY = -Math.random() * 3 - 2;
                this.color = Math.random() > 0.5 ? '#00ffaa' : '#00aaff';
                this.phrase = nicePhrases[Math.floor(Math.random() * nicePhrases.length)];
                this.scoreValue = -5; this.loadImpact = 10;
            } else if (type === 'predator') {
                this.radius = 40; this.speedX = 0; this.speedY = -2;
                this.color = '#800080';
                this.phrase = predatorPhrases[Math.floor(Math.random() * predatorPhrases.length)];
                this.scoreValue = 25; this.loadImpact = -10;
            } else if (type === 'coffee') {
                this.radius = 25; this.speedX = 0; this.speedY = -1.5; 
                this.color = '#6f4e37'; this.phrase = "KAFFE!";
                this.scoreValue = 10; this.loadImpact = -20;
            } else if (type === 'bot') {
                this.radius = 25; this.speedX = (Math.random() > 0.5 ? 10 : -10); this.speedY = -1;
                this.x = this.speedX > 0 ? -50 : width + 50; this.y = Math.random() * (height - 200) + 100;
                this.targetY = this.y; this.color = '#888888';
                this.phrase = botPhrases[Math.floor(Math.random() * botPhrases.length)];
                this.scoreValue = 4; this.loadImpact = -15; this.state = 'roaming';
            } else if (type === 'virus') {
                this.radius = 35; this.speedX = (Math.random() - 0.5) * 8; this.speedY = -Math.random() * 5;
                this.color = '#00ff00'; this.phrase = "FATAL ERROR";
                this.scoreValue = 0; this.loadImpact = 0;
            } else if (type === 'alcohol') {
                this.radius = 25; this.speedX = (Math.random() - 0.5) * 6; this.speedY = -Math.random() * 4 - 2;
                this.color = '#FFA500'; this.phrase = "√òL?";
                this.scoreValue = 0; this.loadImpact = 5;
            } else if (type === 'party_troll') {
                this.speedX = (Math.random() - 0.5) * 7; this.speedY = -Math.random() * 5 - 2;
                this.color = '#ff00ff'; 
                this.phrase = partyInsults[Math.floor(Math.random() * partyInsults.length)];
                this.scoreValue = 5; this.loadImpact = -5;
            } else if (type === 'golden_troll') {
                this.radius = 30;
                this.speedX = (Math.random() - 0.5) * 12; // Super fast
                this.speedY = (Math.random() - 0.5) * 12;
                this.color = '#FFD700';
                this.phrase = goldenPhrases[Math.floor(Math.random() * goldenPhrases.length)];
                this.scoreValue = 50; this.loadImpact = -50;
                this.state = 'roaming';
            } else if (type === 'boss') {
                this.radius = 100; this.x = width/2; this.y = -100; this.targetY = 150;
                this.speedX = 0; this.speedY = 2;
                this.color = '#8B0000'; // Dark Red
                this.phrase = "JEG ER SJEFEN!";
                this.scoreValue = 0; this.loadImpact = 0;
            } else if (type === 'complaint') {
                this.radius = 20; this.color = '#FF0000';
                this.phrase = complaintWords[Math.floor(Math.random() * complaintWords.length)];
                this.scoreValue = 1; this.loadImpact = 0;
                this.state = 'roaming';
            } else if (type === 'digit') {
                this.radius = 30; this.color = '#FFFFFF';
                this.phrase = nextDigit.toString();
                this.scoreValue = 0; this.loadImpact = 0;
                this.speedY = 2; this.x = width/2; this.y = 150; // Spit from boss
                this.state = 'falling';
            } else if (type === 'popup') {
                this.radius = 40; this.speedX = 0; this.speedY = 0;
                this.x = Math.random() * (width - 100) + 50;
                this.y = Math.random() * (height - 100) + 50;
                this.color = '#C0C0C0'; // classic windows grey
                this.phrase = popupPhrases[Math.floor(Math.random() * popupPhrases.length)];
                this.scoreValue = 3; this.loadImpact = 0;
                this.state = 'static';
                this.timer = 0;
            } else if (type === 'clippy') {
                this.radius = 20; 
                this.speedX = (Math.random() - 0.5) * 15; // fast zigzag
                this.speedY = (Math.random() - 0.5) * 15;
                this.color = '#C0C0C0';
                this.phrase = clippyPhrases[Math.floor(Math.random() * clippyPhrases.length)];
                this.scoreValue = 10; this.loadImpact = -5;
                this.state = 'roaming';
            }
        }

        update() {
            if (this.type === 'boss') {
                if (this.y < this.targetY) this.y += this.speedY;
                this.x = width/2 + Math.sin(frame * 0.02) * 100; // Hover
                return;
            }

            if (this.type === 'popup') {
                this.timer++;
                // Multiply if alive too long (3 seconds = 180 frames)
                if (this.timer > 180) {
                    this.timer = 0;
                    this.markedForDeletion = true;
                    // Spawn 2 new ones
                    for(let i=0; i<2; i++) {
                        let p = new Entity('popup');
                        p.x = Math.max(50, Math.min(width-50, this.x + (Math.random()-0.5)*100));
                        p.y = Math.max(50, Math.min(height-50, this.y + (Math.random()-0.5)*100));
                        entities.push(p);
                    }
                    createExplosion(this.x, this.y, '#C0C0C0', false);
                    sfx.pop();
                }
                return;
            }

            if (this.type === 'clippy') {
                this.x += this.speedX;
                this.y += this.speedY;
                // Bounce
                if (this.x < 20 || this.x > width - 20) this.speedX *= -1;
                if (this.y < 20 || this.y > height - 20) this.speedY *= -1;
                // Change direction randomly
                if(Math.random() < 0.05) {
                    this.speedX = (Math.random() - 0.5) * 15;
                    this.speedY = (Math.random() - 0.5) * 15;
                }
            }

            if (this.type === 'complaint') {
                // Track nearest innocent
                let nearest = null; let minDistSq = 9999999;
                entities.forEach(e => {
                    if (e.type === 'innocent') {
                        const distSq = (e.x-this.x)**2 + (e.y-this.y)**2;
                        if (distSq < minDistSq) { minDistSq = distSq; nearest = e; }
                    }
                });
                
                if (nearest) {
                    const angle = Math.atan2(nearest.y - this.y, nearest.x - this.x);
                    this.x += Math.cos(angle) * 3; this.y += Math.sin(angle) * 3;
                    if (minDistSq < (this.radius + nearest.radius)**2) {
                        // INFECT!
                        this.markedForDeletion = true;
                        nearest.type = 'troll'; // Transform
                        nearest.color = '#ff0055';
                        nearest.phrase = "BL√Ü!";
                        createExplosion(nearest.x, nearest.y, '#ff0055', false);
                        sfx.bad();
                    }
                } else {
                    this.y += 2; // Fall if no target
                }
                if(this.y > height + 50) this.markedForDeletion = true;
                return;
            }

            if (this.type === 'digit') {
                this.y += this.speedY;
                if (this.y > height + 50) {
                    // Missed digit, respawn it later? For now, just delete and boss cycle will repeat
                    this.markedForDeletion = true;
                }
                return;
            }

            // --- STANDARD MOVEMENT LOGIC REUSED ---
            if (this.type === 'predator' && this.state === 'roaming') {
                let nearest = null; let minDistSq = 9999999;
                entities.forEach(e => {
                    if (e.type === 'innocent') {
                        const distSq = (e.x-this.x)**2 + (e.y-this.y)**2;
                        if (distSq < minDistSq) { minDistSq = distSq; nearest = e; }
                    }
                });
                if (nearest) {
                    const angle = Math.atan2(nearest.y - this.y, nearest.x - this.x);
                    this.x += Math.cos(angle) * 2.5; this.y += Math.sin(angle) * 2.5;
                    if (minDistSq < (this.radius+nearest.radius)**2) {
                        nearest.markedForDeletion = true;
                        createExplosion(nearest.x, nearest.y, '#ff0000', false);
                        serverLoad += 5; sfx.bad();
                    }
                } else {
                    this.x += Math.sin(frame * 0.02) * 2; this.y += Math.cos(frame * 0.02) * 2;
                }
                this.x = Math.max(50, Math.min(width-50, this.x));
                this.y = Math.max(50, Math.min(height-50, this.y));

            } else if (this.type === 'bot') {
                this.x += this.speedX;
                if (this.x < -100 || this.x > width + 100) this.markedForDeletion = true;
            } else if (this.type === 'golden_troll') {
                this.x += this.speedX + Math.sin(frame * 0.2) * 5;
                this.y += this.speedY + Math.cos(frame * 0.2) * 5;
                if (this.x < 50 || this.x > width - 50) this.speedX *= -1;
                if (this.y < 50 || this.y > height - 50) this.speedY *= -1;
                if(frame % 5 === 0) particles.push({x: this.x, y: this.y, vx: 0, vy: 0, life: 0.5, color: '#FFD700', size: 4});
            } else if (this.type === 'virus') {
                this.x += this.speedX + (Math.random() - 0.5) * 10;
                this.y += Math.sin(frame * 0.1) * 5;
                if (this.x < 50 || this.x > width - 50) this.speedX *= -1;
                if (this.y < 50 || this.y > height - 50) this.y = Math.random() * height;
            } else {
                if (this.state === 'entering') {
                    this.y += this.speedY;
                    if (this.y <= this.targetY) this.state = 'roaming';
                } else {
                    this.x += this.speedX;
                    this.y += Math.sin(frame * 0.05) * 2;
                    if (this.x < 50 || this.x > width - 50) this.speedX *= -1;
                }
            }

            this.phraseTimer++;
            if (this.phraseTimer > 100) {
                this.showPhrase = true;
                if (this.phraseTimer > 250) { this.showPhrase = false; this.phraseTimer = 0; }
            }
        }

        draw() {
            ctx.shadowBlur = 0; this.pulse += 0.1;
            if (this.type === 'predator') { ctx.shadowBlur = 10 + Math.sin(this.pulse) * 5; ctx.shadowColor = '#ff00ff'; } 
            else if (this.type === 'virus') { ctx.shadowBlur = 15; ctx.shadowColor = '#00ff00'; }
            else if (this.type === 'party_troll') { ctx.shadowBlur = 10 + (beatPulse*20); ctx.shadowColor = '#00ffff'; }
            else if (this.type === 'golden_troll') { ctx.shadowBlur = 20; ctx.shadowColor = '#FFD700'; }
            else if (this.type === 'boss') { ctx.shadowBlur = 30; ctx.shadowColor = '#ff0000'; }

            ctx.fillStyle = this.color;
            
            if (this.type === 'boss') {
                // MEGA TROLL
                ctx.fillRect(this.x - 100, this.y - 80, 200, 160);
                // Big Eyes
                ctx.fillStyle = '#fff';
                ctx.fillRect(this.x - 60, this.y - 40, 40, 40);
                ctx.fillRect(this.x + 20, this.y - 40, 40, 40);
                ctx.fillStyle = '#000';
                ctx.fillRect(this.x - 50, this.y - 30, 20, 20);
                ctx.fillRect(this.x + 30, this.y - 30, 20, 20);
                // Mouth
                ctx.fillRect(this.x - 80, this.y + 40, 160, 20);
                // Teeth
                ctx.fillStyle = '#fff';
                ctx.fillRect(this.x - 70, this.y + 40, 20, 10);
                ctx.fillRect(this.x + 50, this.y + 40, 20, 10);
            } else if (this.type === 'digit') {
                ctx.beginPath(); ctx.arc(this.x, this.y, 30, 0, Math.PI*2);
                ctx.fill(); ctx.strokeStyle = '#000'; ctx.stroke();
            } else if (this.type === 'predator') {
                ctx.beginPath(); ctx.moveTo(this.x, this.y - 30); ctx.lineTo(this.x + 25, this.y + 20); ctx.lineTo(this.x - 25, this.y + 20); ctx.fill();
            } else if (this.type === 'coffee') {
                ctx.fillRect(this.x - 15, this.y - 15, 30, 30);
                ctx.fillStyle = '#fff'; ctx.globalAlpha = 0.6;
                ctx.fillRect(this.x - 5, this.y - 25 - (frame%20)/2, 4, 8); ctx.globalAlpha = 1.0;
            } else if (this.type === 'bot') {
                ctx.fillRect(this.x - 20, this.y - 15, 40, 30); 
                ctx.beginPath(); ctx.moveTo(this.x, this.y-15); ctx.lineTo(this.x, this.y-25); ctx.stroke();
                ctx.beginPath(); ctx.arc(this.x, this.y-25, 3, 0, Math.PI*2); ctx.fill();
            } else if (this.type === 'virus') {
                ctx.fillStyle = Math.random() > 0.5 ? '#00ff00' : '#000000';
                ctx.strokeStyle = '#00ff00'; ctx.lineWidth = 2;
                ctx.fillRect(this.x - 20, this.y - 20, 40, 40); ctx.strokeRect(this.x - 22, this.y - 22, 44, 44);
            } else if (this.type === 'alcohol') {
                // Beer glass
                ctx.fillStyle = '#FFA500';
                ctx.fillRect(this.x - 10, this.y - 15, 20, 30);
                ctx.fillStyle = '#FFF'; 
                ctx.fillRect(this.x - 12, this.y - 20, 24, 8);
                ctx.strokeStyle = '#FFF'; ctx.lineWidth = 2;
                ctx.strokeRect(this.x - 10, this.y - 15, 20, 30);
            } else if (this.type === 'party_troll') {
                ctx.fillRect(this.x - 20, this.y - 20, 40, 40);
                // Party Hat
                ctx.fillStyle = '#FFFF00';
                ctx.beginPath(); ctx.moveTo(this.x - 20, this.y - 20); ctx.lineTo(this.x, this.y - 50); ctx.lineTo(this.x + 20, this.y - 20); ctx.fill();
            } else if (this.type === 'golden_troll') {
                ctx.fillStyle = '#FFD700'; 
                ctx.fillRect(this.x - 20, this.y - 20, 40, 40);
                ctx.fillStyle = '#FFF';
                ctx.beginPath(); 
                ctx.moveTo(this.x - 20, this.y - 30); ctx.lineTo(this.x - 10, this.y - 20); ctx.lineTo(this.x, this.y - 35); ctx.lineTo(this.x + 10, this.y - 20); ctx.lineTo(this.x + 20, this.y - 30); ctx.lineTo(this.x + 20, this.y - 20); ctx.lineTo(this.x - 20, this.y - 20); ctx.fill();
            } else if (this.type === 'popup') {
                ctx.fillStyle = '#C0C0C0';
                ctx.fillRect(this.x - 40, this.y - 30, 80, 60);
                // Title bar
                ctx.fillStyle = '#000080';
                ctx.fillRect(this.x - 38, this.y - 28, 76, 15);
                // X button
                ctx.fillStyle = '#C0C0C0';
                ctx.fillRect(this.x + 25, this.y - 26, 10, 10);
                // Text
                ctx.fillStyle = '#000';
                ctx.font = "12px 'VT323'";
                ctx.textAlign = 'center';
                ctx.fillText(this.phrase, this.x, this.y + 10);
            } else if (this.type === 'clippy') {
                // Paperclip shape simplified
                ctx.strokeStyle = '#C0C0C0';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(this.x, this.y - 10, 10, Math.PI, 0);
                ctx.lineTo(this.x + 10, this.y + 10);
                ctx.arc(this.x, this.y + 10, 10, 0, Math.PI);
                ctx.lineTo(this.x - 10, this.y);
                ctx.stroke();
                // Eyes
                ctx.fillStyle = '#000';
                ctx.fillRect(this.x - 5, this.y - 15, 3, 3);
                ctx.fillRect(this.x + 2, this.y - 15, 3, 3);
            } else if (this.type === 'complaint') {
                // Just a bubble, drawn below
            } else {
                ctx.fillRect(this.x - 20, this.y - 20, 40, 40);
            }
            
            // Faces (Skip for items)
            if (['coffee', 'virus', 'alcohol', 'boss', 'digit', 'complaint', 'popup', 'clippy'].indexOf(this.type) === -1) {
                ctx.fillStyle = '#fff';
                ctx.fillRect(this.x - 12, this.y - 10, 10, 10); ctx.fillRect(this.x + 2, this.y - 10, 10, 10);
                ctx.fillStyle = '#000';
                if (this.type === 'troll' || this.type === 'party_troll' || this.type === 'golden_troll') {
                     ctx.fillRect(this.x - 8, this.y - 6, 4, 4); ctx.fillRect(this.x + 6, this.y - 6, 4, 4);
                     ctx.fillRect(this.x - 10, this.y + 12, 20, 4);
                } else if (this.type === 'innocent') {
                     ctx.beginPath(); ctx.arc(this.x, this.y + 8, 8, 0, Math.PI); ctx.stroke();
                } else if (this.type === 'bot') {
                     ctx.fillRect(this.x - 10, this.y + 8, 20, 2);
                }
            }
            
            if (this.showPhrase || this.type === 'boss' || this.type === 'digit' || this.type === 'complaint' || this.type === 'clippy') {
                ctx.save();
                ctx.font = currentLevel === 4 ? "bold 22px Arial" : "28px 'VT323'";
                
                if (this.type === 'digit') {
                    ctx.fillStyle = '#000'; ctx.font = "bold 40px 'VT323'"; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillText(this.phrase, this.x, this.y);
                } else if (this.type === 'complaint') {
                    ctx.fillStyle = '#FF0000'; ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
                    const w = ctx.measureText(this.phrase).width + 10;
                    ctx.fillRect(this.x - w/2, this.y - 15, w, 30); ctx.strokeRect(this.x - w/2, this.y - 15, w, 30);
                    ctx.fillStyle = '#fff'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillText(this.phrase, this.x, this.y);
                } else if (this.type === 'popup') {
                    // Text already handled
                } else {
                    ctx.fillStyle = '#fff'; 
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    
                    const w = ctx.measureText(this.phrase).width + 20;
                    const h = 40; 
                    const bY = (this.type === 'boss') ? this.y + 80 : this.y - 75; 
                    
                    ctx.fillRect(this.x - w/2, bY, w, h);
                    ctx.strokeRect(this.x - w/2, bY, w, h);
                    
                    if (this.type !== 'boss') {
                        ctx.beginPath();
                        ctx.moveTo(this.x, bY + h);
                        ctx.lineTo(this.x - 5, bY + h + 8);
                        ctx.lineTo(this.x + 5, bY + h);
                        ctx.fill(); ctx.stroke();
                    }

                    ctx.fillStyle = '#000'; 
                    ctx.textAlign = 'center'; 
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.phrase, this.x, bY + h/2 + 2); 
                }
                ctx.restore();
            }
        }
    }

    function checkHits() {
        let hitSomething = false;

        for (let i = entities.length - 1; i >= 0; i--) {
            const e = entities[i];
            const distSq = (e.x - mouseX)**2 + (e.y - mouseY)**2;
            let radius = e.type === 'predator' ? 80 : (e.type === 'boss' ? 100 : 70);
            
            // RAGE MODE RADIUS
            if (rageMode) radius *= 2;
            
            if (isTouchInput) radius *= 1.4; 

            if (distSq < radius * radius) { 
                hitSomething = true;
                let points = e.scoreValue;
                let isGoodHit = false;

                if (rageMode) points *= 2;

                if (e.type === 'boss') {
                    createExplosion(e.x, e.y + 50, '#ff0000', true);
                    sfx.hit();
                } else if (e.type === 'digit') {
                    isGoodHit = true;
                    createExplosion(e.x, e.y, '#fff', true);
                    collectedDigits.push(e.phrase);
                    updatePhoneDisplay();
                    sfx.powerup();
                    if(collectedDigits.length >= 8) {
                        momPhoneBtn.style.display = 'flex';
                        floatText.push(new FloatingText(width/2, height/2, "RING N√Ö!", "#fff"));
                    }
                } else if (e.type === 'complaint') {
                    isGoodHit = true;
                    createExplosion(e.x, e.y, '#ff0000', false);
                    sfx.hit();
                } else if (e.type === 'troll' || e.type === 'bot' || e.type === 'party_troll' || e.type === 'popup' || e.type === 'clippy') {
                    isGoodHit = true; if(e.type === 'bot') points = 5;
                    createExplosion(e.x, e.y, e.color, true); incrementCombo();
                } else if (e.type === 'predator') {
                    isGoodHit = true; createExplosion(e.x, e.y, '#ff00ff', true);
                    shakeIntensity = 40; hitStop = 8; glitchEffect = 10; incrementCombo();
                } else if (e.type === 'golden_troll') {
                    isGoodHit = true; createExplosion(e.x, e.y, '#FFD700', true);
                    shakeIntensity = 30; hitStop = 5; 
                    floatText.push(new FloatingText(e.x, e.y, "JACKPOT!", "#FFD700"));
                    incrementCombo(); sfx.rare();
                } else if (e.type === 'coffee') {
                    isGoodHit = true; createExplosion(e.x, e.y, '#fff', true);
                    serverLoad = Math.max(0, serverLoad - 20); 
                    drunkLevel = Math.max(0, drunkLevel - 50); 
                    let msg = (currentLevel === 6) ? "EDRU!" : "CAFFEINE!";
                    floatText.push(new FloatingText(e.x, e.y, msg, "#fff"));
                    sfx.powerup();
                } else if (e.type === 'innocent') {
                    resetCombo(); createExplosion(e.x, e.y, e.color, false);
                } else if (e.type === 'virus') {
                    resetCombo(); createExplosion(e.x, e.y, '#00ff00', true);
                    score -= 50; blackoutOverlay.style.opacity = 1; 
                    setTimeout(() => blackoutOverlay.style.opacity = 0, 2000); sfx.error();
                } else if (e.type === 'alcohol') {
                    resetCombo(); createExplosion(e.x, e.y, '#FFA500', true);
                    drunkLevel = Math.min(drunkLevel + 50, 100); 
                    floatText.push(new FloatingText(e.x, e.y, "FULL?!", "#FFA500"));
                    sfx.drunk();
                }

                if (isGoodHit && e.type !== 'coffee' && e.type !== 'golden_troll') {
                    sfx.hit(); score += points * (1 + Math.floor(combo/5)); serverLoad += e.loadImpact; triggerFlash();
                } else if (e.type === 'golden_troll') {
                    score += points * (1 + Math.floor(combo/5)); serverLoad += e.loadImpact; triggerFlash();
                } else if (!isGoodHit && e.type !== 'virus' && e.type !== 'alcohol' && e.type !== 'boss') {
                    score += points; serverLoad += e.loadImpact; sfx.bad();
                }
                
                scoreEl.innerText = score;
                if (e.type !== 'boss') entities.splice(i, 1); 
                
                checkLevelProgress();
                if (entities.length === 0) return;
            }
        }

        if (!hitSomething) {
            resetCombo();
        }
    }

    function updatePhoneDisplay() {
        let display = "";
        for(let i=0; i<8; i++) {
            if (i < collectedDigits.length) display += collectedDigits[i] + " ";
            else display += "_ ";
        }
        phoneNumberDisplay.innerText = display;
    }

    function createExplosion(x, y, colorStr, isBig) {
        const count = isBig ? 50 : 15;
        for (let i = 0; i < count; i++) particles.push({
             x: x, y: y, vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15, 
             life: 1.0, color: colorStr, size: Math.random()*8+3
        });
        if(isBig) shockwaves.push({x:x, y:y, radius:10, color:colorStr, life:1.0});
    }

    function drawHammer() {
        cursorCtx.clearRect(0, 0, width, height);
        cursorCtx.save();
        
        let swayRot = 0; let swayX = 0;
        if (drunkLevel > 0) {
             swayRot = Math.sin(frame * 0.1) * (drunkLevel * 0.5);
             swayX = Math.cos(frame * 0.08) * (drunkLevel * 0.3);
        }

        cursorCtx.translate(mouseX + swayX, mouseY);
        cursorCtx.rotate((hammerRotation + swayRot) * Math.PI / 180);
        
        // RAGE MODE SCALE
        if (rageMode) cursorCtx.scale(1.5, 1.5);

        let handleColor = '#8B4513';
        let headColor = '#555';
        let headStroke = '#999';
        let glowColor = 'transparent';
        let blur = 0;

        if (rageMode) {
            handleColor = '#330000'; headColor = '#FF4500'; headStroke = '#FFFF00'; glowColor = '#FF4500'; blur = 40;
        } else if (score > 1000) { 
            const hue = (frame * 5) % 360;
            handleColor = '#000'; headColor = '#111'; headStroke = `hsl(${hue}, 100%, 50%)`; glowColor = headStroke; blur = 30;
        } else if (score > 600) { 
            handleColor = '#fff'; headColor = '#00FFFF'; headStroke = '#fff'; glowColor = '#00FFFF'; blur = 20;
        } else if (score > 300) { 
            handleColor = '#DAA520'; headColor = '#FFD700'; headStroke = '#FFFFE0'; glowColor = '#FFD700'; blur = 10;
        } else if (score > 100) { 
            handleColor = '#333'; headColor = '#AAA'; headStroke = '#FFF';
        }

        cursorCtx.fillStyle = handleColor; cursorCtx.fillRect(-10, 0, 20, 100);
        cursorCtx.shadowBlur = blur; cursorCtx.shadowColor = glowColor; cursorCtx.strokeStyle = headStroke; cursorCtx.fillStyle = headColor; cursorCtx.lineWidth = 3;
        cursorCtx.fillRect(-40, -40, 80, 50); cursorCtx.strokeRect(-40, -40, 80, 50);
        cursorCtx.shadowBlur = 0; 
        cursorCtx.fillStyle = '#ff0000'; cursorCtx.font = "bold 20px 'VT323'"; cursorCtx.textAlign = 'center';
        cursorCtx.fillText("BAN", 0, -10);
        
        cursorCtx.restore();
    }

    function checkLevelProgress() {
        const nextLvl = currentLevel + 1;
        if (LEVEL_THRESHOLDS[nextLvl] && score >= LEVEL_THRESHOLDS[nextLvl]) {
            createExplosion(width/2, height/2, '#FF00FF', true);
            createExplosion(width/4, height/3, '#FFFF00', true);
            createExplosion(width*0.75, height/3, '#00FFFF', true);
            triggerLevelUp(nextLvl);
        }
        updateProgressBar();
    }

    function updateProgressBar() {
        if (currentLevel === 8) { progressContainer.style.display = 'none'; return; }
        const currentThresh = LEVEL_THRESHOLDS[currentLevel];
        const nextThresh = LEVEL_THRESHOLDS[currentLevel + 1];
        if (!nextThresh) { progressFillEl.style.width = '100%'; return; }
        const range = nextThresh - currentThresh;
        const progress = Math.max(0, score - currentThresh);
        const pct = Math.min(100, (progress / range) * 100);
        progressFillEl.style.width = `${pct}%`;
    }

    function triggerLevelUp(lvl) {
        gameActive = false; currentLevel = lvl;
        levelDescEl.innerText = `Laster inn: ${LEVEL_NAMES[lvl]}`;
        // SHOW HINT
        if(LEVEL_HINTS[lvl]) {
            levelHintEl.innerText = LEVEL_HINTS[lvl];
        } else {
            levelHintEl.innerText = "";
        }
        levelUpEl.style.display = 'flex'; entities = []; sfx.powerup(); 
    }

    function nextLevel() {
        levelUpEl.style.display = 'none';
        levelEl.innerText = `LEVEL: ${currentLevel} - ${LEVEL_NAMES[currentLevel]}`;
        
        uiLayer.style.color = '#33ff00'; 
        vignetteOverlay.style.opacity = 0; 

        if (currentLevel === 3) { levelEl.style.color = '#ff0055'; uiLayer.style.color = '#ff0055'; vignetteOverlay.style.opacity = 1; }
        else if (currentLevel === 4) { levelEl.style.color = '#1DA1F2'; uiLayer.style.color = '#1DA1F2'; }
        else if (currentLevel === 5) { levelEl.style.color = '#00ff00'; uiLayer.style.color = '#00ff00'; }
        else if (currentLevel === 6) { levelEl.style.color = '#FFFF00'; uiLayer.style.color = '#FFFF00'; }
        else if (currentLevel === 7) { levelEl.style.color = '#008080'; uiLayer.style.color = '#008080'; } // Teal
        else if (currentLevel === 8) { 
            levelEl.style.color = '#FF0000'; uiLayer.style.color = '#FF0000'; 
            bossHud.style.display = 'block';
            initBossFight();
        }
        
        updateProgressBar(); stopMusic(); startMusic(); 
        if (currentLevel !== 8) initBackgroundElements(); 
        gameActive = true;
    }

    function initBossFight() {
        entities = [];
        entities.push(new Entity('boss'));
        // Spawn innocent hostages
        for(let i=0; i<6; i++) entities.push(new Entity('innocent'));
        collectedDigits = [];
        nextDigit = 1;
        updatePhoneDisplay();
        bossState = 'attack';
        bossTimer = 0;
    }

    function startGame() {
        initAudio(); startMusic(); gameActive = true;
        score = 0; combo = 0; serverLoad = 0; currentLevel = 1; drunkLevel = 0; rageMode = false;
        entities = []; particles = []; floatText = []; shockwaves = [];
        scoreEl.innerText = score; livesEl.innerText = serverLoad;
        levelEl.innerText = "LEVEL: 1 - THE VOID";
        
        uiLayer.style.color = '#33ff00'; vignetteOverlay.style.opacity = 0;
        comboDisplayEl.style.display = 'none'; rageDisplayEl.style.display = 'none';
        startScreenEl.style.display = 'none'; 
        gameOverEl.style.display = 'none'; gameWinEl.style.display = 'none';
        bossHud.style.display = 'none'; momPhoneBtn.style.display = 'none';
        progressContainer.style.display = 'flex';
        
        resize(); updateProgressBar();
    }

    function resetGame() { startGame(); }
    
    function gameOver() {
        gameActive = false; stopMusic(); finalScoreEl.innerText = score;
        if (score > highScore) { highScore = score; localStorage.setItem('banHammerHighScore', highScore); highscoreEl.innerText = highScore; }
        gameOverEl.style.display = 'flex'; sfx.bad(); 
    }

    function drawBackground() {
        if (currentLevel === 4) ctx.fillStyle = '#002244'; 
        else if (currentLevel === 6) {
            const hue = (frame * 2) % 360;
            ctx.fillStyle = `hsl(${hue}, 50%, 10%)`; 
        } else if (currentLevel === 8) {
            ctx.fillStyle = '#100'; // Dark red for boss
        } else if (currentLevel === 7) {
            ctx.fillStyle = '#008080'; // Windows Teal
        }
        else ctx.fillStyle = '#000'; 
        
        ctx.fillRect(0, 0, width, height);

        if (currentLevel >= 2 && currentLevel !== 8) {
            ctx.font = currentLevel === 4 ? "20px Arial" : "16px 'VT323'"; ctx.textAlign = 'left';
            let spawnRate = 20; if(currentLevel === 5) spawnRate = 5; 
            if (frame % spawnRate === 0) bgElements.push(createBgElement());

            if(currentLevel === 2) {
                ctx.strokeStyle = '#33ff00'; ctx.lineWidth = 2;
                ctx.strokeRect(10, 10, width-20, height-20);
                ctx.fillStyle = '#33ff00'; ctx.fillRect(10, 10, width-20, 30);
                ctx.fillStyle = '#000'; ctx.font = "20px 'VT323'"; ctx.fillText("mIRC32 - #chat [Connected]", 20, 32);
            }

            if(currentLevel === 4) {
                ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.fillRect(width - 200, 0, 200, height);
                ctx.fillStyle = '#fff'; ctx.font = "bold 20px Arial"; ctx.fillText("Trending", width - 180, 40);
                ctx.font = "14px Arial";
                hashtags.forEach((tag, i) => { ctx.fillText(tag, width - 180, 80 + (i*30)); });
            }

            for (let i = bgElements.length - 1; i >= 0; i--) {
                let el = bgElements[i];
                if (currentLevel === 4) el.x += el.speed; else el.y += (currentLevel === 2 ? -el.speed : el.speed);
                let color = `rgba(0, 255, 0, ${el.opacity})`; 
                if (currentLevel === 4) color = `rgba(255, 255, 255, ${el.opacity})`;
                
                if(currentLevel === 5 && Math.random() > 0.95) ctx.fillStyle = '#fff'; else ctx.fillStyle = color;
                
                ctx.font = currentLevel === 4 ? "20px Arial" : "16px 'VT323'";
                ctx.fillText(el.text, el.x, el.y);
                
                if (currentLevel === 2 && el.y < 40) bgElements.splice(i, 1); 
                else if (currentLevel === 5 && el.y > height) bgElements.splice(i, 1);
                else if (currentLevel === 4 && el.x > width - 200) bgElements.splice(i, 1);
                else if (currentLevel === 7 && el.y > height) bgElements.splice(i, 1); // Desktop rain? No, maybe static elements?
            }
        }
    }

    function animate() {
        drawHammer();
        beatPulse *= 0.9;
        if (hitStop > 0) { hitStop--; requestAnimationFrame(animate); return; }
        drawBackground();

        if (gameActive) {
            // RAGE MODE LOGIC
            if (combo > 15 && !rageMode) {
                rageMode = true;
                rageTimer = 300; // 5 seconds
                rageDisplayEl.style.display = 'block';
                sfx.powerup();
            }
            if (rageMode) {
                rageTimer--;
                if(rageTimer <= 0) {
                    rageMode = false;
                    rageDisplayEl.style.display = 'none';
                }
            }

            // DRUNK LOGIC
            if (drunkLevel > 0) {
                drunkLevel -= 0.1; 
                const swayX = Math.sin(frame * 0.05) * (drunkLevel * 0.5);
                const swayY = Math.cos(frame * 0.03) * (drunkLevel * 0.5);
                ctx.save(); ctx.translate(swayX, swayY);
                const rot = Math.sin(frame * 0.02) * (drunkLevel * 0.0005);
                ctx.rotate(rot);
                drunkOverlay.style.backdropFilter = `blur(${Math.min(drunkLevel/20, 5)}px)`;
            } else { drunkOverlay.style.backdropFilter = `blur(0px)`; }

            if (glitchEffect > 0) {
                ctx.save(); ctx.translate((Math.random()-0.5)*10, 0); 
                ctx.globalCompositeOperation = 'screen'; ctx.fillStyle = 'rgba(255, 0, 0, 0.5)'; ctx.fillRect(0,0,width,height);
                ctx.restore(); glitchEffect--;
            }

            let loadShake = 0;
            if (serverLoad > 40) loadShake = (serverLoad - 40) / 5;
            let totalShake = shakeIntensity + loadShake;

            if (totalShake > 0) { ctx.save(); ctx.translate((Math.random()-0.5)*totalShake, (Math.random()-0.5)*totalShake); }
            if (shakeIntensity > 0) { shakeIntensity *= 0.9; if (shakeIntensity < 0.5) shakeIntensity = 0; }

            // --- BOSS LOGIC ---
            if (currentLevel === 8) {
                bossTimer++;
                // Check fail condition: No innocents left
                const innocents = entities.filter(e => e.type === 'innocent');
                if (innocents.length === 0) {
                    gameOverReasonEl.innerText = "Alle barna ble til troll!";
                    gameOver();
                }

                if (bossState === 'attack' && bossTimer > 100) {
                    // Fire complaints
                    for(let i=0; i<3; i++) {
                        let c = new Entity('complaint');
                        c.x = width/2 + (Math.random()-0.5)*100;
                        c.y = 150;
                        entities.push(c);
                    }
                    bossState = 'cooldown';
                    bossTimer = 0;
                } else if (bossState === 'cooldown' && bossTimer > 200) {
                    // Spit digit
                    if (collectedDigits.length < 8) {
                        let d = new Entity('digit');
                        d.phrase = Math.floor(Math.random()*10); // Random digit 0-9
                        entities.push(d);
                    }
                    bossState = 'attack';
                    bossTimer = 0;
                }
            } else {
                // NORMAL SPAWN
                if (frame % 60 === 0) {
                    const max = 5 + (currentLevel * 3) + Math.min(10, score/50);
                    if (entities.length < max) {
                        const r = Math.random(); let type = 'troll';
                        if (Math.random() < 0.005) { type = 'golden_troll'; } 
                        else if (Math.random() < 0.05) { type = 'coffee'; }
                        else if (currentLevel === 4) { if (r < 0.3) type = 'bot'; else if (r < 0.7) type = 'troll'; else type = 'innocent'; }
                        else if (currentLevel === 5) { if (r < 0.15) type = 'virus'; else if (r < 0.3) type = 'predator'; else if (r < 0.7) type = 'troll'; else type = 'innocent'; }
                        else if (currentLevel === 6) { 
                            if (r < 0.2) type = 'alcohol'; 
                            else if (r < 0.5) type = 'party_troll';
                            else if (r < 0.7) type = 'troll';
                            else type = 'innocent'; 
                        }
                        else if (currentLevel === 7) { 
                            if (r < 0.2) type = 'clippy'; 
                            else if (r < 0.5) type = 'popup';
                            else if (r < 0.7) type = 'troll';
                            else type = 'innocent'; 
                        }
                        else if (currentLevel === 3) { if (r < 0.2) type = 'predator'; else if (r < 0.7) type = 'troll'; else type = 'innocent'; }
                        else { if (r < 0.7) type = 'troll'; else type = 'innocent'; }
                        entities.push(new Entity(type));
                    }
                }
            }
            
            if (frame % 30 === 0) {
                let loadIncrease = 0.2; 
                entities.forEach(e => loadIncrease += (e.type === 'bot' ? 2 : (e.type === 'troll' || e.type === 'party_troll' || e.type === 'popup' || e.type === 'clippy' ? 0.5 : 0)));
                serverLoad += loadIncrease;
                if (serverLoad > 100) gameOver();
                livesEl.innerText = Math.floor(serverLoad);
                livesEl.style.color = serverLoad > 80 ? 'red' : 'inherit';
            }

            entities = entities.filter(e => !e.markedForDeletion);
            entities.forEach(e => { e.update(); e.draw(); });
            
            if (totalShake > 0) ctx.restore();
            if (drunkLevel > 0) ctx.restore(); 
        }

        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.03; p.vy += 0.5;
            ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.fillRect(p.x, p.y, p.size, p.size); ctx.globalAlpha = 1;
            if (p.life <= 0) particles.splice(i, 1);
        }
        for (let i = shockwaves.length - 1; i >= 0; i--) {
            let s = shockwaves[i]; s.radius += 15; s.life -= 0.05;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.radius, 0, Math.PI * 2);
            ctx.strokeStyle = s.color; ctx.globalAlpha = s.life; ctx.lineWidth = 10 * s.life; ctx.stroke(); ctx.globalAlpha = 1;
            if (s.life <= 0) shockwaves.splice(i, 1);
        }
        if (combo > 1) { comboDisplayEl.style.display = 'block'; comboCountEl.innerText = combo; } else { comboDisplayEl.style.display = 'none'; }

        for (let i = floatText.length - 1; i >= 0; i--) {
            let f = floatText[i]; f.update(); f.draw();
            if (f.life <= 0) floatText.splice(i, 1);
        }

        frame++;
        requestAnimationFrame(animate);
    }
    
    function incrementCombo() { combo++; }
    function resetCombo() { 
        combo = 0; 
        if(rageMode) { // End rage mode if combo drops
            rageMode = false;
            rageDisplayEl.style.display = 'none';
        }
    }
    function triggerFlash() { flashOverlay.style.opacity = "0.4"; setTimeout(() => flashOverlay.style.opacity = "0", 80); }

    class FloatingText {
        constructor(x, y, text, color = "#ff0000") { this.x = x; this.y = y; this.text = text; this.life = 1.0; this.vy = -3; this.color = color; }
        update() { this.y += this.vy; this.life -= 0.02; }
        draw() { ctx.save(); ctx.globalAlpha = this.life; ctx.font = "bold 40px 'VT323'"; ctx.fillStyle = this.color; ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; ctx.textAlign = "center"; ctx.translate(this.x, this.y); ctx.rotate((Math.random() - 0.5) * 0.1); ctx.fillText(this.text, 0, 0); ctx.strokeText(this.text, 0, 0); ctx.restore(); }
    }

    animate();

</script>
</body>
</html>
